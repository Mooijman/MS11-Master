<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>I2C Diagnostics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="style.css">
  <style>
    .bus-section{margin:20px 0;padding:15px;background-color:#f8f9fa;border-radius:8px}.bus-header{margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid #dee2e6}.bus-title{font-size:16px;font-weight:bold;color:#000;margin:0}.bus-info{font-size:12px;color:#6c757d;margin:5px 0 0 0;font-family:monospace}.bus-info-row{display:flex;gap:15px;flex-wrap:wrap}.device-list{margin:10px 0}.device-item{padding:10px 15px;margin:5px 0;background-color:#fff;border-radius:4px;cursor:pointer;transition:all .2s ease;border:1px solid #e9ecef}.device-item:hover{background-color:#fff;border-color:#000;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.device-header{display:flex;justify-content:space-between;align-items:center}.device-name{color:#000;font-size:14px;font-weight:normal;flex:1;text-align:left}.device-address{color:#6c757d;font-family:monospace;font-size:14px;text-align:right;min-width:120px}.device-bus-badge{display:inline-block;padding:2px 6px;background-color:#000;color:white;border-radius:3px;font-size:11px;margin-left:8px}.register-dump{background-color:#f8f9fa;padding:10px;border-radius:4px;margin-top:10px;max-height:300px;overflow-y:auto}.register-line{font-family:monospace;font-size:12px;line-height:1.6;color:#495057}.metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}.metric-item{background-color:#f8f9fa;padding:8px;border-radius:4px;font-size:13px}.metric-label{color:#6c757d;font-size:11px;text-transform:uppercase}.metric-value{color:#000;font-weight:bold;font-family:monospace}.status-row{display:flex;justify-content:space-between;align-items:center;margin:15px 0}.btn-rescan{padding:5px 15px;background-color:#000;color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px;transition:background-color .2s ease}.btn-rescan:hover{background-color:var(--color-secondary)}.loading-spinner{display:inline-block;width:12px;height:12px;border:2px solid #f3f3f3;border-top:2px solid var(--color-secondary);border-radius:50%;animation:spin 1s linear infinite;margin-left:5px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@media(max-width:768px){.register-line{font-size:9px;line-height:1.4}.bus-info-row{flex-direction:column;gap:5px}}
  </style>
</head>
<body class="card-layout">
  <div class="topnav">
    <img src="waacs-logo.png" alt="Waacs Design & Consultancy">
  </div>
  <div class="content">
    <div class="card-grid">
      <div class="card">
        <div class="header">
          <h1><img src="hex100.png" alt="" class="icon-inline">I2C Diagnostics</h1>
          <a href="/settings" class="card-close">&times;</a>
        </div>

        <div class="padding-top-10">
          <!-- Debug disabled message -->
          <div id="debug-disabled" style="display: none;">
            <p style="color: #d9534f; font-style: italic; text-align: center; margin: 20px 0;">
              Diagnostics are only available when Debug options are enabled.
            </p>
          </div>

          <!-- Debug enabled content -->
          <div id="debug-enabled" style="display: none;">
            <div class="status-row">
              <p class="text-left text-muted line-height-16">
                <strong>Status:</strong> <span id="status">Ready</span>
              </p>
              <button class="btn-rescan" onclick="scanI2C()">Rescan Buses</button>
            </div>

            <div id="scan-results">
              <p class="text-center text-muted">Scanning I2C buses...</p>
            </div>

            <div id="device-details-section"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
const debugEnabled='%DEBUG_ENABLED%'==='true';let allDevices=[];debugEnabled?(document.getElementById('debug-enabled').style.display='block',scanI2C()):document.getElementById('debug-disabled').style.display='block';function scanI2C(){document.getElementById('status').innerHTML='Scanning<span class="loading-spinner"></span>';const resultsDiv=document.getElementById('scan-results');resultsDiv.innerHTML='<p class="text-center text-muted">Scanning I2C buses...</p>';fetch('/api/i2c/scan').then(e=>e.json()).then(data=>{allDevices=[];let html='';if(data.totalDevices===0){html='<p class="text-center text-muted">No I2C devices found on any bus</p>';}else{html='<p class="text-left text-muted line-height-16" style="margin-bottom:15px"><strong>Found '+data.totalDevices+' device(s) total</strong></p>';if(data.bus0){html+='<div class="bus-section">';html+='<div class="bus-header">';html+='<h3 class="bus-title">'+data.bus0.name+'</h3>';html+='<div class="bus-info-row">';html+='<div class="bus-info">Pins: '+data.bus0.pins+'</div>';html+='<div class="bus-info">Speed: '+data.bus0.speed+'</div>';html+='<div class="bus-info">Devices: '+data.bus0.count+'</div>';html+='</div></div>';if(data.bus0.count>0){html+='<div class="device-list">';data.bus0.devices.forEach(device=>{const deviceIndex=allDevices.length;allDevices.push(device);html+='<div class="device-item" onclick="toggleDeviceDetails('+deviceIndex+')">';html+='<div class="device-header">';html+='<div class="device-name">'+device.name+'<span class="device-bus-badge">Bus 0</span></div>';html+='<div class="device-address">'+device.address+'</div>';html+='</div></div>';});html+='</div>';}else{html+='<p class="text-muted" style="margin:10px 0">No devices found</p>';}html+='</div>';}if(data.bus1){html+='<div class="bus-section">';html+='<div class="bus-header">';html+='<h3 class="bus-title">'+data.bus1.name+'</h3>';html+='<div class="bus-info-row">';html+='<div class="bus-info">Pins: '+data.bus1.pins+'</div>';html+='<div class="bus-info">Speed: '+data.bus1.speed+'</div>';html+='<div class="bus-info">Devices: '+data.bus1.count+'</div>';html+='</div></div>';if(data.bus1.count>0){html+='<div class="device-list">';data.bus1.devices.forEach(device=>{const deviceIndex=allDevices.length;allDevices.push(device);html+='<div class="device-item" onclick="toggleDeviceDetails('+deviceIndex+')">';html+='<div class="device-header">';html+='<div class="device-name">'+device.name+'<span class="device-bus-badge">Bus 1</span></div>';html+='<div class="device-address">'+device.address+'</div>';html+='</div></div>';});html+='</div>';}else{html+='<p class="text-muted" style="margin:10px 0">No devices found</p>';}html+='</div>';}}resultsDiv.innerHTML=html;document.getElementById('status').textContent='Ready';document.getElementById('device-details-section').innerHTML='';}).catch(e=>{resultsDiv.innerHTML='<p class="text-center text-error">Scan failed</p>';document.getElementById('status').textContent='Error';console.error('I2C scan error:',e);});}function toggleDeviceDetails(deviceIndex){const device=allDevices[deviceIndex];const detailsDiv=document.getElementById('device-details-section');if(detailsDiv.dataset.currentDevice===deviceIndex.toString()){detailsDiv.innerHTML='';detailsDiv.dataset.currentDevice='';return;}detailsDiv.dataset.currentDevice=deviceIndex;detailsDiv.innerHTML='<hr class="hr-divider"><p class="text-center text-muted">Loading device details<span class="loading-spinner"></span></p>';fetch('/api/i2c/registers?address='+device.decimal+'&bus='+device.bus).then(e=>e.json()).then(data=>{let html='<hr class="hr-divider">';html+='<h3 style="margin-bottom:15px">Device Details: '+device.name+' ('+device.address+')<span class="device-bus-badge">Bus '+device.bus+'</span></h3>';html+='<div class="metrics">';html+='<div class="metric-item"><div class="metric-label">Scan Duration</div><div class="metric-value">'+data.scanDuration+' ms</div></div>';html+='<div class="metric-item"><div class="metric-label">Response Time</div><div class="metric-value">'+data.responseTime+' ms</div></div>';html+='<div class="metric-item"><div class="metric-label">Bus Speed</div><div class="metric-value">'+data.busSpeed+' kHz</div></div>';html+='<div class="metric-item"><div class="metric-label">Errors</div><div class="metric-value">'+data.errors+'</div></div>';html+='</div>';html+='<h4 style="margin-top:20px;margin-bottom:10px">Register Dump (0x00-0xFF)</h4>';html+='<div class="register-dump">';if(data.registers&&data.registers.length>0){for(let i=0;i<data.registers.length;i+=16){let line='<div class="register-line">';line+='0x'+i.toString(16).padStart(2,'0').toUpperCase()+': ';for(let j=0;j<16&&i+j<data.registers.length;j++){line+=data.registers[i+j].toString(16).padStart(2,'0').toUpperCase()+' ';}line+='</div>';html+=line;}}else{html+='<p class="text-muted">Unable to read registers</p>';}html+='</div>';detailsDiv.innerHTML=html;}).catch(e=>{detailsDiv.innerHTML='<hr class="hr-divider"><p class="text-center text-error">Failed to load device details</p>';console.error('Device details error:',e);});}
  </script>
</body>
</html>
