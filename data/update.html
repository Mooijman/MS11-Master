<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firmware Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body class="card-layout">
  <div class="topnav">
    <img src="waacs-logo.png" alt="Waacs Design & Consultancy">
  </div>
  <div class="content">
    <div class="card-grid">
      <div class="card">
        <div class="header">
          <h1><img src="hex100.png" alt="" class="icon-inline">Firmware Update</h1>
          <a href="/" class="card-close">&times;</a>
        </div>
        
        <div class="padding-top-10">
          
          <!-- OTA Update Section -->
          <div>
            
            <div id="update-content">
              <!-- Firmware Info -->
              <div class="margin-bottom-20">
                <p class="text-left text-muted line-height-16">
                  <span class="version-span-inline"><strong>FW</strong></span><span id="fw-info">-</span><br>
                  <span class="version-span-inline"><strong>FS</strong></span><span id="fs-info">-</span>
                </p>
                <p class="italic-muted-text">
                  <span id="update-availability">-</span>
                </p>
              </div>
              
              <hr class="hr-divider">
              
              <!-- Update button (shown when update available) -->
              <div id="update-section" class="text-right hidden">
                <button id="update-btn" class="btn-small btn-update">Update</button>
              </div>
              
              <!-- Reinstall button (shown when debug enabled and up-to-date) -->
              <div id="reinstall-section" class="text-right hidden">
                <button id="reinstall-btn" onclick="reinstallVersion('both')" class="btn-small btn-reinstall">Reinstall</button>
              </div>
            </div>
            
            <div id="update-disabled" class="hidden">
              <p class="text-left text-muted line-height-16">
                <span class="version-span-inline"><strong>FW</strong></span><span id="fw-info-disabled">-</span><br>
                <span class="version-span-inline"><strong>FS</strong></span><span id="fs-info-disabled">-</span>
              </p>
              <p class="italic-muted-text">updates disabled</p>
              
              <hr class="hr-divider">
            </div>
            
            <div id="update-status-section" class="margin-top-20 hidden">
              <div id="update-error" class="margin-bottom-10 error-text hidden">
                <p><strong>Fout:</strong> <span id="error-message"></span></p>
              </div>
              
              <div id="update-warning" class="update-warning-box hidden">
                <p class="update-warning-text"><strong>⚠️ UPDATING DEVICE</strong></p>
                <p class="update-warning-text-spacing">DO NOT DISCONNECT POWER!</p>
              </div>
              
              <div id="update-success" class="update-success-box hidden">
                <p class="update-success-text">✅ Update Successful!</p>
                <p class="reboot-warning-text-spacing" style="color: #2e7d32;">Rebooting device...</p>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let pollInterval;
    let currentUpdateType = ''; // Track which type of update is in progress
    let forcedUpdateInProgress = false;
    let deviceRebooting = false;
    let rebootDetectionCount = 0;

    function updateWarningText() {
      console.log('updateWarningText called, currentUpdateType:', currentUpdateType);
      const warningTextEl = document.querySelector('#update-warning .update-warning-text');
      console.log('warningTextEl:', warningTextEl);
      if (!warningTextEl) {
        console.warn('Warning text element not found!');
        return;
      }
      if (currentUpdateType === 'firmware') {
        warningTextEl.textContent = '⚠️ Updating Firmware';
      } else if (currentUpdateType === 'littlefs') {
        warningTextEl.textContent = '⚠️ Updating Filesystem';
      } else if (currentUpdateType === 'both') {
        warningTextEl.textContent = '⚠️ Updating Device';
      } else {
        warningTextEl.textContent = '⚠️ Updating...';
      }
      console.log('updateWarningText completed');
    }

    function showUpdateInProgressUI() {
      console.log('showUpdateInProgressUI called');
      updateWarningText();
      
      const updateWarning = document.getElementById('update-warning');
      if (updateWarning) updateWarning.style.display = 'block';
      
      const cardClose = document.querySelector('.card .header a.card-close');
      if (cardClose) cardClose.style.display = 'none';
      
      const updateContent = document.getElementById('update-content');
      if (updateContent) updateContent.style.display = 'none';
      
      const updateDisabled = document.getElementById('update-disabled');
      if (updateDisabled) updateDisabled.style.display = 'none';
      
      const updateStatusSection = document.getElementById('update-status-section');
      if (updateStatusSection) updateStatusSection.style.display = 'block';
      
      const rebootRequired = document.getElementById('reboot-required');
      if (rebootRequired) rebootRequired.style.display = 'none';
      
      console.log('showUpdateInProgressUI completed');
    }
    
    function updateStatus() {
      fetch('/api/update/status')
        .then(response => response.json())
        .then(data => {
          // Strip fw-/fs- prefix from version strings (for backwards compatibility)
          const fwVersion = data.currentFirmwareVersion.replace(/^(fw-|fs-)/, '');
          const fsVersion = data.currentFilesystemVersion.replace(/^(fw-|fs-)/, '');
          
          // Get available versions - strip both fw- and fs- prefixes
          const fwAvailableVersion = data.availableFirmwareVersion ? data.availableFirmwareVersion.replace(/^(fw-|fs-)/, '') : '';
          const fsAvailableVersion = data.availableFilesystemVersion ? data.availableFilesystemVersion.replace(/^(fw-|fs-)/, '') : '';
          
          // Update firmware info section with arrows if update available
          if (data.firmwareAvailable && fwAvailableVersion) {
            document.getElementById('fw-info').textContent = fwVersion + ' → ' + fwAvailableVersion;
          } else {
            document.getElementById('fw-info').textContent = fwVersion;
          }
          
          if (data.littlefsAvailable && fsAvailableVersion) {
            document.getElementById('fs-info').textContent = fsVersion + ' → ' + fsAvailableVersion;
          } else {
            document.getElementById('fs-info').textContent = fsVersion;
          }
          
          // Check if updates are enabled
          if (!data.updatesEnabled) {
            // Show disabled view
            document.getElementById('update-content').style.display = 'none';
            document.getElementById('update-disabled').style.display = 'block';
            document.getElementById('fw-info-disabled').textContent = fwVersion;
            document.getElementById('fs-info-disabled').textContent = fsVersion;
            document.getElementById('update-status-section').style.display = 'none';
            return; // Don't process further if updates disabled
          }
          
          // Show enabled view
          document.getElementById('update-content').style.display = 'block';
          document.getElementById('update-disabled').style.display = 'none';
          
          // Check for error state first
          if (data.state === 6 && data.lastError && data.lastError.length > 0) {
            // Show error in red italic on the update-availability line
            document.getElementById('update-availability').innerHTML = '<span style="color: #d9534f; font-style: italic;">Update failed: ' + data.lastError + '</span>';
            // Hide Update button
            document.getElementById('update-section').style.display = 'none';
            document.getElementById('reinstall-section').style.display = 'none';
          } else if (data.firmwareAvailable || data.littlefsAvailable) {
            // Update available
            document.getElementById('update-availability').textContent = 'update available';
            document.getElementById('update-availability').style.color = '#999';
            // Show Update button and set correct type
            const updateBtn = document.getElementById('update-btn');
            if (data.firmwareAvailable && data.littlefsAvailable) {
              updateBtn.onclick = () => installUpdate('both');
            } else if (data.firmwareAvailable) {
              updateBtn.onclick = () => installUpdate('firmware');
            } else {
              updateBtn.onclick = () => installUpdate('littlefs');
            }
            document.getElementById('update-section').style.display = 'block';
            document.getElementById('reinstall-section').style.display = 'none';
          } else if (data.lastCheck > 0) {
            // Up-to-date
            document.getElementById('update-availability').textContent = 'up-to-date';
            document.getElementById('update-availability').style.color = '#999';
            // Hide Update button
            document.getElementById('update-section').style.display = 'none';
            // Show Reinstall button if debug is enabled
            if (data.debugEnabled) {
              console.log('Debug enabled, showing reinstall button');
              const reinstallBtn = document.getElementById('reinstall-btn');
              if (reinstallBtn) {
                console.log('Reinstall button found, attaching onclick');
                reinstallBtn.onclick = () => {
                  console.log('Dynamic onclick triggered');
                  reinstallVersion('both');
                };
              } else {
                console.error('Reinstall button element not found!');
              }
              document.getElementById('reinstall-section').style.display = 'block';
            } else {
              console.log('Debug disabled, hiding reinstall button');
              document.getElementById('reinstall-section').style.display = 'none';
            }
          } else {
            // Check if GitHub token is missing when updates are enabled
            if (data.updatesEnabled && !data.hasGithubToken) {
              document.getElementById('update-availability').innerHTML = '<span style="color: #d9534f; font-style: italic;">Missing GitHub Token. Check settings.</span>';
            } else {
              document.getElementById('update-availability').textContent = '-';
            }
            document.getElementById('update-actions').style.display = 'none';
            document.getElementById('update-status-section').style.display = 'none';
            // Hide Update button
            document.getElementById('update-section').style.display = 'none';
            document.getElementById('reinstall-section').style.display = 'none';
          }
          
          // Hide the separate error box since error is now shown on update-availability line
          document.getElementById('update-error').style.display = 'none';
          
          // Show progress during download/install
          if (data.state === 3 || data.state === 4) { // DOWNLOADING or INSTALLING
            forcedUpdateInProgress = true;
            showUpdateInProgressUI();
            startPolling();
          } else if (forcedUpdateInProgress && (data.state === 0 || data.state === 1 || data.state === 2)) {
            // Show warning immediately after confirm, before download starts
            showUpdateInProgressUI();
            startPolling();
          } else {
            document.getElementById('update-warning').style.display = 'none';
            document.querySelector('.card .header a.card-close').style.display = '';
            document.getElementById('update-content').style.display = 'block';
            document.getElementById('update-disabled').style.display = 'none';
            if (data.state !== 2 && data.state !== 1) { // Not AVAILABLE or CHECKING
              stopPolling();
            }
          }
          
          // Auto reload after successful update (firmware or filesystem)
          if (data.state === 6) { // ERROR
            forcedUpdateInProgress = false;
          }
          if (data.state === 5) { // SUCCESS
            forcedUpdateInProgress = false;
            // Hide all content except update-success box
            document.getElementById('update-content').style.display = 'none';
            document.getElementById('update-disabled').style.display = 'none';
            document.getElementById('update-warning').style.display = 'none';
            document.getElementById('update-success').style.display = 'block';
            document.getElementById('update-status-section').style.display = 'block';
            document.querySelector('.card .header a.card-close').style.display = 'none';
            stopPolling();
            setTimeout(() => {
              window.location.href = '/';
            }, 3000);
          }
        })
        .catch(error => {
          console.error('Status update failed:', error);
          // If we're in forced update mode and get connection error, device is rebooting
          if (forcedUpdateInProgress && !deviceRebooting) {
            rebootDetectionCount++;
            console.log('Connection lost during update (count: ' + rebootDetectionCount + '), device rebooting...');
            // First connection error = device is rebooting, redirect immediately to confirm page
            console.log('Reboot detected, redirecting to success page...');
            deviceRebooting = true;
            stopPolling();
            window.location.href = '/confirm.html?message=%E2%9C%85%20Update%20Successful!&type=success';
          }
        });
    }
    
    function startPolling() {
      if (!pollInterval) {
        pollInterval = setInterval(updateStatus, 500);
      }
    }
    
    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }
    
    function checkForUpdate() {
      console.log('checkForUpdate() called');
      console.log('Fetching /api/update/check');
      fetch('/api/update/check', { method: 'POST' })
        .then(response => {
          console.log('Response received:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Data received:', data);
          setTimeout(updateStatus, 1000);
        })
        .catch(error => {
          console.error('Fetch error:', error);
        });
    }
    
    function installUpdate(type) {
      console.log('installUpdate called with type:', type);
      currentUpdateType = type;
      if (!confirm('Device will restart after update. Continue?')) return;
      
      console.log('User confirmed, starting update...');
      forcedUpdateInProgress = true;
      deviceRebooting = false;
      rebootDetectionCount = 0;
      showUpdateInProgressUI();
      startPolling();
      
      fetch('/api/update/install', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'type=' + type
      })
      .then(response => response.json())
      .then(data => {
        console.log('Response data:', data);
        if (data.rebootRequired) {
          console.log('Reboot required, redirecting to success page immediately');
          stopPolling();
          window.location.href = '/confirm.html?message=%E2%9C%85%20Update%20Successful!&type=success';
        } else if (!data.success) {
          console.error('Update failed:', data.message);
          alert('Update failed: ' + data.message);
          document.getElementById('update-warning').style.display = 'none';
          stopPolling();
        }
      })
      .catch(error => {
        console.error('Update error:', error);
        // Don't stop polling on error during download - device may still be updating
      });
    }
    
    function reinstallVersion(type) {
      console.log('reinstallVersion called with type:', type);
      currentUpdateType = type;
      if (!confirm('This will reinstall the current version. Device will restart. Continue?')) {
        console.log('User cancelled reinstall');
        return;
      }
      
      console.log('User confirmed, starting reinstall...');
      forcedUpdateInProgress = true;
      deviceRebooting = false;
      rebootDetectionCount = 0;
      showUpdateInProgressUI();
      startPolling();
      
      fetch('/api/update/reinstall', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'type=' + type
      })
      .then(response => response.json())
      .then(data => {
        console.log('Response data:', data);
        if (data.rebootRequired) {
          console.log('Reboot required, redirecting to success page immediately');
          stopPolling();
          window.location.href = '/confirm.html?message=%E2%9C%85%20Update%20Successful!&type=success';
        } else if (!data.success) {
          console.error('Reinstall failed:', data.message);
          alert('Reinstall failed: ' + data.message);
          document.getElementById('update-warning').style.display = 'none';
          stopPolling();
        }
      })
      .catch(error => {
        console.error('Reinstall error:', error);
        // Don't stop polling on error during download - device may still be updating
      });
    }
    
    // Test function to verify API communication
    function testAPICall() {
      console.log('=== TEST API CALL ===');
      console.log('Calling /api/update/status...');
      fetch('/api/update/status')
        .then(response => {
          console.log('Status code:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('API Response:', data);
          alert('API test successful! Check console for details.');
        })
        .catch(error => {
          console.error('API test failed:', error);
          alert('API test failed! Check console for error.');
        });
    }
    
    // Initial load - check once on page open
    console.log('Page loaded, starting update check in 1 second...');
    updateStatus();
    // Automatically check for updates on page load
    setTimeout(() => {
      console.log('Timeout fired, calling checkForUpdate()');
      checkForUpdate();
    }, 1000);
  </script>
</body>
</html>
