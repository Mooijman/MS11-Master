<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firmware Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body class="card-layout">
  <div class="topnav">
    <img src="waacs-logo.png" alt="Waacs Design & Consultancy">
  </div>
  <div class="content">
    <div class="card-grid">
      <div class="card">
        <div class="header">
          <h1><img src="hex100.png" alt="" class="icon-inline">Firmware Update</h1>
          <a href="/" class="card-close">&times;</a>
        </div>
        
        <div class="padding-top-10">
          
          <!-- OTA Update Section -->
          <div>
            
            <div id="update-content">
              <!-- Firmware Info -->
              <div class="margin-bottom-20">
                <p class="text-left text-muted line-height-16">
                  <span class="version-span-inline"><strong>FW</strong></span><span id="fw-info">-</span><br>
                  <span class="version-span-inline"><strong>FS</strong></span><span id="fs-info">-</span>
                </p>
                <p class="italic-muted-text">
                  <span id="update-availability">-</span>
                </p>
              </div>
              
              <hr class="hr-divider">
              
              <!-- Update button (shown when update available) -->
              <div id="update-section" class="text-right hidden">
                <button id="update-btn" class="btn-small btn-update">Update</button>
              </div>
              
              <!-- Reinstall button (shown when debug enabled and up-to-date) -->
              <div id="reinstall-section" class="text-right hidden">
                <button id="reinstall-btn" class="btn-small btn-reinstall">Reinstall</button>
              </div>
            </div>
            
            <div id="update-disabled" class="hidden">
              <p class="text-left text-muted line-height-16">
                <span class="version-span-inline"><strong>FW</strong></span><span id="fw-info-disabled">-</span><br>
                <span class="version-span-inline"><strong>FS</strong></span><span id="fs-info-disabled">-</span>
              </p>
              <p class="italic-muted-text">updates disabled</p>
              
              <hr class="hr-divider">
            </div>
            
            <div id="update-status-section" class="margin-top-20 hidden">
              <div id="update-error" class="margin-bottom-10 error-text hidden">
                <p><strong>Fout:</strong> <span id="error-message"></span></p>
              </div>
              
              <div id="update-warning" class="update-warning-box hidden">
                <p class="update-warning-text"><strong>⚠️ UPDATING DEVICE</strong></p>
                <p class="update-warning-text-spacing">DO NOT DISCONNECT POWER!</p>
              </div>
              
              <div id="reboot-required" class="reboot-warning-box hidden">
                <p class="reboot-warning-text"><strong>⚠️ Filesystem updated.</strong></p>
                <p class="reboot-warning-text-spacing">Power cycle the device now.</p>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let pollInterval;
    let currentUpdateType = ''; // Track which type of update is in progress
    let forcedUpdateInProgress = false;

    function updateWarningText() {
      const warningTextEl = document.querySelector('#update-warning .update-warning-text');
      if (!warningTextEl) return;
      if (currentUpdateType === 'firmware') {
        warningTextEl.textContent = '⚠️ Updating Firmware';
      } else if (currentUpdateType === 'littlefs') {
        warningTextEl.textContent = '⚠️ Updating Filesystem';
      } else if (currentUpdateType === 'both') {
        warningTextEl.textContent = '⚠️ Updating Device';
      } else {
        warningTextEl.textContent = '⚠️ Updating...';
      }
    }

    function showUpdateInProgressUI() {
      updateWarningText();
      document.getElementById('update-warning').style.display = 'block';
      document.querySelector('.card .header a.card-close').style.display = 'none';
      document.getElementById('update-content').style.display = 'none';
      document.getElementById('update-disabled').style.display = 'none';
      document.getElementById('update-status-section').style.display = 'block';
      document.getElementById('reboot-required').style.display = 'none';
    }
    
    function updateStatus() {
      fetch('/api/update/status')
        .then(response => response.json())
        .then(data => {
          // Strip fw-/fs- prefix from version strings (for backwards compatibility)
          const fwVersion = data.currentFirmwareVersion.replace(/^(fw-|fs-)/, '');
          const fsVersion = data.currentFilesystemVersion.replace(/^(fw-|fs-)/, '');
          
          // Get available versions - strip both fw- and fs- prefixes
          const fwAvailableVersion = data.availableFirmwareVersion ? data.availableFirmwareVersion.replace(/^(fw-|fs-)/, '') : '';
          const fsAvailableVersion = data.availableFilesystemVersion ? data.availableFilesystemVersion.replace(/^(fw-|fs-)/, '') : '';
          
          // Update firmware info section with arrows if update available
          if (data.firmwareAvailable && fwAvailableVersion) {
            document.getElementById('fw-info').textContent = fwVersion + ' → ' + fwAvailableVersion;
          } else {
            document.getElementById('fw-info').textContent = fwVersion;
          }
          
          if (data.littlefsAvailable && fsAvailableVersion) {
            document.getElementById('fs-info').textContent = fsVersion + ' → ' + fsAvailableVersion;
          } else {
            document.getElementById('fs-info').textContent = fsVersion;
          }
          
          // Check if updates are enabled
          if (!data.updatesEnabled) {
            // Show disabled view
            document.getElementById('update-content').style.display = 'none';
            document.getElementById('update-disabled').style.display = 'block';
            document.getElementById('fw-info-disabled').textContent = fwVersion;
            document.getElementById('fs-info-disabled').textContent = fsVersion;
            document.getElementById('update-status-section').style.display = 'none';
            return; // Don't process further if updates disabled
          }
          
          // Show enabled view
          document.getElementById('update-content').style.display = 'block';
          document.getElementById('update-disabled').style.display = 'none';
          
          // Update availability text - use grey color for both
          if (data.firmwareAvailable || data.littlefsAvailable) {
            document.getElementById('update-availability').textContent = 'update available';
            document.getElementById('update-availability').style.color = '#999';
            // Show Update button and set correct type
            const updateBtn = document.getElementById('update-btn');
            if (data.firmwareAvailable && data.littlefsAvailable) {
              updateBtn.onclick = () => installUpdate('both');
            } else if (data.firmwareAvailable) {
              updateBtn.onclick = () => installUpdate('firmware');
            } else {
              updateBtn.onclick = () => installUpdate('littlefs');
            }
            document.getElementById('update-section').style.display = 'block';
            document.getElementById('reinstall-section').style.display = 'none';
          } else if (data.lastCheck > 0) {
            document.getElementById('update-availability').textContent = 'up-to-date';
            document.getElementById('update-availability').style.color = '#999';
            // Hide Update button
            document.getElementById('update-section').style.display = 'none';
            // Show Reinstall button if debug is enabled
            if (data.debugEnabled) {
              const reinstallBtn = document.getElementById('reinstall-btn');
              reinstallBtn.onclick = () => reinstallVersion('both');
              document.getElementById('reinstall-section').style.display = 'block';
            } else {
              document.getElementById('reinstall-section').style.display = 'none';
            }
          } else {
            // Check if GitHub token is missing when updates are enabled
            if (data.updatesEnabled && !data.hasGithubToken) {
              document.getElementById('update-availability').innerHTML = '<span style="color: #d9534f; font-style: italic;">Missing GitHub Token. Check settings.</span>';
            } else {
              document.getElementById('update-availability').textContent = '-';
            }
            document.getElementById('update-actions').style.display = 'none';
            document.getElementById('update-status-section').style.display = 'none';
            // Hide Update button
            document.getElementById('update-section').style.display = 'none';
            document.getElementById('reinstall-section').style.display = 'none';
          }
          
          // Show error if present
          if (data.lastError && data.lastError.length > 0) {
            document.getElementById('update-error').style.display = 'block';
            document.getElementById('error-message').textContent = data.lastError;
            document.getElementById('update-status-section').style.display = 'block';
          } else {
            document.getElementById('update-error').style.display = 'none';
          }
          
          // Show progress during download/install
          if (data.state === 3 || data.state === 4) { // DOWNLOADING or INSTALLING
            forcedUpdateInProgress = true;
            showUpdateInProgressUI();
            startPolling();
          } else if (forcedUpdateInProgress && (data.state === 0 || data.state === 1 || data.state === 2)) {
            // Show warning immediately after confirm, before download starts
            showUpdateInProgressUI();
            startPolling();
          } else {
            document.getElementById('update-warning').style.display = 'none';
            document.querySelector('.card .header a.card-close').style.display = '';
            document.getElementById('update-content').style.display = 'block';
            document.getElementById('update-disabled').style.display = 'none';
            if (data.state !== 2 && data.state !== 1) { // Not AVAILABLE or CHECKING
              stopPolling();
            }
          }
          
          // Auto reload after successful firmware update (not filesystem)
          if (data.state === 6) { // ERROR
            forcedUpdateInProgress = false;
          }
          if (data.state === 5 && !data.filesystemUpdateDone) { // SUCCESS - firmware only
            forcedUpdateInProgress = false;
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else if (data.state === 5 && data.filesystemUpdateDone) { // SUCCESS - filesystem
            forcedUpdateInProgress = false;
            // Hide all content except reboot-required box
            document.getElementById('update-content').style.display = 'none';
            document.getElementById('update-disabled').style.display = 'none';
            document.getElementById('update-warning').style.display = 'none';
            document.getElementById('reboot-required').style.display = 'block';
            document.getElementById('update-status-section').style.display = 'block';
            document.querySelector('.card .header a.card-close').style.display = 'none';
            stopPolling();
          }
        })
        .catch(error => {
          console.error('Status update failed:', error);
        });
    }
    
    function startPolling() {
      if (!pollInterval) {
        pollInterval = setInterval(updateStatus, 2000);
      }
    }
    
    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }
    
    function checkForUpdate() {
      console.log('checkForUpdate() called');
      console.log('Fetching /api/update/check');
      fetch('/api/update/check', { method: 'POST' })
        .then(response => {
          console.log('Response received:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Data received:', data);
          setTimeout(updateStatus, 1000);
        })
        .catch(error => {
          console.error('Fetch error:', error);
        });
    }
    
    function installUpdate(type) {
      console.log('installUpdate called with type:', type);
      currentUpdateType = type; // Store the update type for display purposes
      if (!confirm('Device will restart after update. Continue?')) return;
      
      console.log('User confirmed, starting update...');
      forcedUpdateInProgress = true;
      showUpdateInProgressUI();
      startPolling();
      
      fetch('/api/update/install', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'type=' + type
      })
      .then(response => {
        console.log('Response received:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.rebootRequired) {
          console.log('Reboot required, device will restart');
        } else if (!data.success) {
          stopPolling();
        }
      })
      .catch(error => {
        console.error('Update error:', error);
        stopPolling();
      });
    }
    
    function reinstallVersion(type) {
      console.log('reinstallVersion called with type:', type);
      currentUpdateType = type;
      if (!confirm('This will reinstall the current version. Device will restart. Continue?')) return;
      
      console.log('User confirmed, starting reinstall...');
      forcedUpdateInProgress = true;
      showUpdateInProgressUI();
      startPolling();
      
      fetch('/api/update/reinstall', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'type=' + type
      })
      .then(response => {
        console.log('Response received:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.rebootRequired) {
          console.log('Reboot required, device will restart');
        } else if (!data.success) {
          stopPolling();
        }
      })
      .catch(error => {
        console.error('Reinstall error:', error);
        stopPolling();
      });
    }
    
    // Initial load - check once on page open
    console.log('Page loaded, starting update check in 1 second...');
    updateStatus();
    // Automatically check for updates on page load
    setTimeout(() => {
      console.log('Timeout fired, calling checkForUpdate()');
      checkForUpdate();
    }, 1000);
  </script>
</body>
</html>
