<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firmware Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="style.css">
  <style>
    .btn-update:hover {
      background-color: #e74c3c !important;
      border-color: #c0392b !important;
    }
  </style>
</head>
<body class="card-layout">
  <div class="topnav">
    <img src="waacs-logo.png" alt="Waacs Design & Consultancy">
  </div>
  <div class="content">
    <div class="card-grid">
      <div class="card">
        <div class="header">
          <h1><img src="hex100.png" alt="" class="icon-inline">Firmware Update</h1>
          <a href="/" class="card-close">&times;</a>
        </div>
        
        <div class="padding-top-20">
          
          <!-- OTA Update Section -->
          <div>
            
            <div id="update-content">
              <!-- Firmware Info -->
              <div class="margin-bottom-20">
                <p class="text-left text-muted" style="line-height: 1.6;">
                  <span style="display: inline-block; width: 30px;"><strong>FW</strong></span><span id="fw-info">-</span><br>
                  <span style="display: inline-block; width: 30px;"><strong>FS</strong></span><span id="fs-info">-</span>
                </p>
                <p style="font-style:italic; color:#999; margin-top:10px; text-align:left;">
                  <span id="update-availability">-</span>
                </p>
              </div>
              
              <hr style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">
              
              <!-- Update button (shown when update available) -->
              <div id="update-section" class="text-right" style="display:none;">
                <button id="update-btn" onclick="installUpdate('both')" class="btn-small btn-update">Update</button>
              </div>
            </div>
            
            <div id="update-disabled" style="display:none;">
              <p class="text-left text-muted" style="line-height: 1.6;">
                <span style="display: inline-block; width: 30px;"><strong>FW</strong></span><span id="fw-info-disabled">-</span><br>
                <span style="display: inline-block; width: 30px;"><strong>FS</strong></span><span id="fs-info-disabled">-</span>
              </p>
              <p style="font-style:italic;color:#999;margin-top:10px;text-align:left;">updates disabled</p>
              
              <hr style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">
            </div>
            
            <div id="update-status-section" style="display:none;" class="margin-top-20">
              <div id="update-error" class="margin-bottom-10" style="display:none;color:#e74c3c;">
                <p><strong>Fout:</strong> <span id="error-message"></span></p>
              </div>
              
              <div id="update-actions" class="margin-bottom-20" style="display:none;">
                <div class="flex-row">
                  <button onclick="installUpdate('firmware')" class="btn-small" style="flex:1;">Installeer Firmware</button>
                  <button onclick="installUpdate('littlefs')" class="btn-small" style="flex:1;">Installeer Filesystem</button>
                  <button onclick="installUpdate('both')" class="btn-small" style="flex:1;">Installeer Alles</button>
                </div>
              </div>
              
              <div id="progress-ota" style="display:none;">
                <div class="progress-bar-bg">
                  <div id="progress-bar-ota" class="progress-bar" style="width:0%"></div>
                </div>
                <p id="progress-text-ota" class="progress-text text-center">0%</p>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let pollInterval;
    
    function updateStatus() {
      fetch('/api/update/status')
        .then(response => response.json())
        .then(data => {
          // Strip fw-/fs- prefix from version strings
          const fwVersion = data.currentFirmwareVersion.replace(/^fw-/, '');
          const fsVersion = data.currentFilesystemVersion.replace(/^fs-/, '');
          
          // Update firmware info section
          document.getElementById('fw-info').textContent = fwVersion;
          document.getElementById('fs-info').textContent = fsVersion;
          
          // Check if updates are enabled
          if (!data.updatesEnabled) {
            // Show disabled view
            document.getElementById('update-content').style.display = 'none';
            document.getElementById('update-disabled').style.display = 'block';
            document.getElementById('fw-info-disabled').textContent = fwVersion;
            document.getElementById('fs-info-disabled').textContent = fsVersion;
            document.getElementById('update-status-section').style.display = 'none';
            return; // Don't process further if updates disabled
          }
          
          // Show enabled view
          document.getElementById('update-content').style.display = 'block';
          document.getElementById('update-disabled').style.display = 'none';
          
          // Update availability text
          if (data.firmwareAvailable || data.littlefsAvailable) {
            document.getElementById('update-availability').textContent = 'update available';
            document.getElementById('update-availability').style.color = '#27ae60';
            document.getElementById('update-actions').style.display = 'block';
            document.getElementById('update-status-section').style.display = 'block';
            // Show Update button
            document.getElementById('update-section').style.display = 'block';
          } else if (data.lastCheck > 0) {
            document.getElementById('update-availability').textContent = 'up-to-date';
            document.getElementById('update-availability').style.color = '#999';
            document.getElementById('update-actions').style.display = 'none';
            document.getElementById('update-status-section').style.display = 'none';
            // Hide Update button
            document.getElementById('update-section').style.display = 'none';
          } else {
            document.getElementById('update-availability').textContent = '-';
            document.getElementById('update-actions').style.display = 'none';
            document.getElementById('update-status-section').style.display = 'none';
            // Hide Update button
            document.getElementById('update-section').style.display = 'none';
          }
          
          // Show error if present
          if (data.lastError && data.lastError.length > 0) {
            document.getElementById('update-error').style.display = 'block';
            document.getElementById('error-message').textContent = data.lastError;
            document.getElementById('update-status-section').style.display = 'block';
          } else {
            document.getElementById('update-error').style.display = 'none';
          }
          
          // Show progress during download/install
          if (data.state === 3 || data.state === 4) { // DOWNLOADING or INSTALLING
            document.getElementById('progress-ota').style.display = 'block';
            document.getElementById('progress-bar-ota').style.width = data.downloadProgress + '%';
            document.getElementById('progress-text-ota').textContent = data.downloadProgress + '%';
            document.getElementById('update-status-section').style.display = 'block';
            startPolling();
          } else {
            document.getElementById('progress-ota').style.display = 'none';
            if (data.state !== 2 && data.state !== 1) { // Not AVAILABLE or CHECKING
              stopPolling();
            }
          }
          
          // Auto reload after successful update
          if (data.state === 5) { // SUCCESS
            setTimeout(() => {
              alert('Update succesvol! Device herstart...');
              window.location.reload();
            }, 2000);
          }
        })
        .catch(error => {
          console.error('Status update failed:', error);
        });
    }
    
    function startPolling() {
      if (!pollInterval) {
        pollInterval = setInterval(updateStatus, 2000);
      }
    }
    
    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }
    
    function checkForUpdate() {
      document.getElementById('update-status').textContent = 'Controleren...';
      document.getElementById('update-status-section').style.display = 'block';
      fetch('/api/update/check', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          setTimeout(updateStatus, 1000);
          if (data.success) {
            if (data.updateAvailable) {
              alert('Update beschikbaar!');
            } else {
              alert('Geen updates beschikbaar.');
            }
          } else {
            alert('Check mislukt. Controleer de update URL in settings.');
          }
        })
        .catch(error => {
          alert('Check mislukt: ' + error);
        });
    }
    
    function installUpdate(type) {
      const typeText = type === 'firmware' ? 'Firmware' : type === 'littlefs' ? 'Filesystem' : 'Firmware en Filesystem';
      if (!confirm('Device zal herstarten na ' + typeText + ' update. Doorgaan?')) return;
      
      document.getElementById('update-status').textContent = 'Downloaden...';
      startPolling();
      
      fetch('/api/update/install', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'type=' + type
      })
      .then(response => response.json())
      .then(data => {
        if (data.rebootRequired) {
          alert('Update gestart! Device herstart...');
        } else if (!data.success) {
          alert('Update mislukt: ' + data.message);
          stopPolling();
        }
      })
      .catch(error => {
        alert('Update mislukt: ' + error);
        stopPolling();
      });
    }
    
    // Initial load - check once on page open
    updateStatus();
    // Automatically check for updates on page load
    setTimeout(() => {
      checkForUpdate();
    }, 1000);
  </script>
</body>
</html>
