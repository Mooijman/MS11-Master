<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twiboot Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body class="card-layout">
  <div class="topnav">
    <img src="waacs-logo.png" alt="Waacs Design & Consultancy">
  </div>
  <div class="content">
    <div class="card-grid">
      <div class="card">
        <div class="header">
          <h1><img src="hex100.png" alt="" class="icon-inline">Twiboot Update</h1>
          <a href="/" class="card-close">&times;</a>
        </div>
        
        <div class="padding-top-10">
          
          <!-- Info Section -->
          <div class="margin-bottom-20">
            <p class="text-left text-muted line-height-16">
              <strong>Arduino Pro Mini</strong><br>
              <span id="bootloader-status">-</span><br>
              <span id="chip-info">-</span>
            </p>
            <p class="italic-muted-text" id="connection-status">
              Checking connection...
            </p>
          </div>
          
          <hr class="hr-divider">
          
          <!-- Upload Section -->
          <div id="upload-section" class="hidden">
            <div class="margin-bottom-20">
              <label for="hex-file" class="form-label">Intel HEX File:</label>
              <input type="file" id="hex-file" accept=".hex" class="form-input">
              <p class="text-small text-muted">Select a .hex firmware file for the Arduino</p>
            </div>
            
            <div id="upload-info" class="margin-bottom-20 hidden">
              <p class="text-muted">
                File: <span id="file-name">-</span><br>
                Size: <span id="file-size">-</span> bytes
              </p>
            </div>
            
            <!-- Progress Bar -->
            <div id="progress-section" class="margin-top-20 hidden">
              <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
              </div>
              <p class="text-center text-small">
                <span id="progress-text">0%</span>
              </p>
              <p id="progress-status" class="text-center text-small text-muted">Preparing...</p>
            </div>
            
            <div class="text-right margin-top-20">
              <button id="upload-btn" class="btn-small btn-update" onclick="startUpload()">Upload</button>
            </div>
          </div>
          
          <!-- Error Section -->
          <div id="error-section" class="hidden">
            <p class="error-text"><strong>Error:</strong></p>
            <p id="error-message" class="text-small text-muted"></p>
            <div class="text-right margin-top-20">
              <button class="btn-small" onclick="location.reload()">Retry</button>
            </div>
          </div>
          
          <!-- Success Section -->
          <div id="success-section" class="hidden">
            <p class="text-success"><strong>✅ Update Successful!</strong></p>
            <p class="text-small text-muted margin-top-10">Arduino will restart now.</p>
            <div class="text-right margin-top-20">
              <button class="btn-small" onclick="location.href='/'">Done</button>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let selectedFile = null;
    
    function checkBootloaderStatus() {
      console.log('Checking bootloader status...');
      fetch('/api/twi/status')
        .then(response => response.json())
        .then(data => {
          if (data.connected) {
            document.getElementById('bootloader-status').textContent = 'Connected ✓';
            document.getElementById('chip-info').textContent = 'Signature: ' + data.signature;
            document.getElementById('connection-status').textContent = 'Bootloader version: ' + data.version;
            document.getElementById('upload-section').style.display = 'block';
          } else {
            document.getElementById('bootloader-status').textContent = 'Not Connected';
            document.getElementById('connection-status').innerHTML = '<span style="color: #d9534f;">Bootloader not responding on I2C 0x29</span>';
          }
        })
        .catch(error => {
          console.error('Status check failed:', error);
          document.getElementById('connection-status').innerHTML = '<span style="color: #d9534f;">Connection error</span>';
        });
    }
    
    document.getElementById('hex-file').addEventListener('change', function(e) {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        document.getElementById('file-name').textContent = selectedFile.name;
        document.getElementById('file-size').textContent = selectedFile.size;
        document.getElementById('upload-info').style.display = 'block';
      } else {
        document.getElementById('upload-info').style.display = 'none';
      }
    });
    
    function startUpload() {
      if (!selectedFile) {
        alert('Please select a hex file');
        return;
      }
      
      if (!confirm('Upload firmware to Arduino? Device will restart.')) {
        return;
      }
      
      console.log('Starting upload of ' + selectedFile.name);
      document.getElementById('upload-section').style.display = 'none';
      document.getElementById('progress-section').style.display = 'block';
      
      // Read file content
      const reader = new FileReader();
      reader.onload = function(e) {
        const hexContent = e.target.result;
        console.log('File loaded, ' + hexContent.length + ' bytes');
        
        // Send to server
        fetch('/api/twi/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            hexContent: hexContent
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log('Upload response:', data);
          if (data.success) {
            showSuccess();
          } else {
            showError(data.error || 'Upload failed');
          }
        })
        .catch(error => {
          console.error('Upload error:', error);
          showError('Upload failed: ' + error);
        });
        
        // Update progress
        updateProgressWithInterval(hexContent.length);
      };
      reader.readAsText(selectedFile);
    }
    
    function updateProgressWithInterval(totalSize) {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 30;
        if (progress > 90) progress = 90;  // Don't reach 100% until complete
        
        updateProgress(Math.floor(progress), totalSize);
        
        if (progress >= 90) {
          clearInterval(interval);
        }
      }, 500);
    }
    
    function updateProgress(percent, totalSize) {
      document.getElementById('progress-fill').style.width = percent + '%';
      document.getElementById('progress-text').textContent = percent + '%';
      
      if (percent < 30) {
        document.getElementById('progress-status').textContent = 'Requesting bootloader mode...';
      } else if (percent < 50) {
        document.getElementById('progress-status').textContent = 'Erasing memory...';
      } else if (percent < 90) {
        document.getElementById('progress-status').textContent = 'Writing flash...';
      } else {
        document.getElementById('progress-status').textContent = 'Finalizing...';
      }
    }
    
    function showError(message) {
      document.getElementById('progress-section').style.display = 'none';
      document.getElementById('error-section').style.display = 'block';
      document.getElementById('error-message').textContent = message;
    }
    
    function showSuccess() {
      document.getElementById('progress-section').style.display = 'none';
      document.getElementById('progress-fill').style.width = '100%';
      document.getElementById('progress-text').textContent = '100%';
      document.getElementById('success-section').style.display = 'block';
    }
    
    // Check status on page load
    checkBootloaderStatus();
  </script>
</body>
</html>
